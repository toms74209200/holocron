# 書庫アプリ 要件・Tech Stack

## 要件

### 機能要件
1. **ユーザー登録**
   - Firebase Anonymous認証後、ユーザー名を設定
   - ユーザー名は変更可能

2. **書籍登録**
   - ISBN入力で書籍情報自動取得
   - バーコードスキャン対応

3. **書籍一覧・検索**
   - 貸出可能/貸出中のステータス表示
   - 貸出中の場合は利用者名を表示
   - タイトル・著者で検索

4. **貸出・返却**
   - バーコードスキャンで貸出（貸出者名を記録）
   - バーコードスキャンで返却

5. **書籍削除**
   - 貸出可能な書籍のみ削除可能（貸出中は削除不可）
   - 削除理由を必須で記録
     - 譲渡：他の人に譲った
     - 破棄：廃棄処分した
     - 紛失：紛失した
     - その他：上記以外の理由
   - 削除メモ（任意）：詳細な理由や備考を記録
   - 削除はBookDeletedイベントとして記録（イベントソーシング）
   - ReadModelからは除外されるが、イベント履歴には残る

### 非機能要件
- イベントソーシング
- CQRS（Command/Query分離）
- 結果整合性（トランザクションロック回避）
- アプリ内goroutineでイベント処理→読み取りモデル更新

## Tech Stack

### フロントエンド
- Next.js (App Router)
- Firebase Auth (Anonymous Login)
- バーコードスキャンライブラリ

### バックエンド
- Go (標準 `net/http`)
- OpenAPI Generator (`oapi-codegen`)
- sqlc
- Firebase Admin SDK（UID検証用）

### データベース
- SQLite (`:memory:` or 一時ファイル)
- 本番移行時はPostgreSQL + pg_cron

### テスト
- Small test: Property-Based Testing (`gopter`)
- Medium test: Testcontainers
- Large test: 外部システムに接続する場合のテスト
- Web API test: Testcontainers

### アーキテクチャ
- Presentation層: OpenAPI自動生成
- Orchestration層: Command/Query分離
- Logic層: 純粋関数
- Data層: EventStore + ReadModel

## 画面仕様

### ナビゲーション構成

ボトムナビゲーション（3タブ）:
```
┌─────────────────────────────┐
│        Header (Logo)        │
├─────────────────────────────┤
│                             │
│       Main Content          │
│                             │
├─────────────────────────────┤
│ [ライブラリ] [貸出・返却] [その他] │
└─────────────────────────────┘
```

### 画面遷移

```
[アプリ起動]
    │
    ↓ (自動匿名認証 + ユーザー自動生成「ゲストXXXX」)
    │
    └─→ ボトムナビゲーション
         │
         ├─→ [ライブラリ] ─→ [書籍詳細]
         │                    ├→ 書籍登録（ヘッダーの + ボタン）
         │                    ├→ 貸出/返却（ボタン操作）
         │                    └→ 削除
         │
         ├─→ [貸出・返却]
         │     ├→ バーコードスキャン（貸出/返却）
         │     └→ 借りている本一覧 → マニュアル返却
         │
         └─→ [その他]
               ├→ ユーザー名変更
               └→ 設定・その他機能
```

### ライブラリ（書籍一覧）

**画面構成:**
- ヘッダー
  - ロゴ
  - 「+ 登録」ボタン → 書籍登録画面へ遷移
- 検索バー（タイトル・著者で検索）
- 書籍一覧（無限スクロール）
  - サムネイル
  - タイトル
  - 著者
  - 貸出ステータス（貸出可能 / 貸出中）
  - 貸出中の場合は利用者名を表示

**ユースケース:**
1. **書籍を探す**
   - ユーザーがライブラリタブを開く
   - 検索バーにキーワードを入力
   - 該当する書籍がリアルタイムでフィルタリング表示される

2. **書籍詳細を見る**
   - ユーザーが書籍カードをタップ
   - 書籍詳細画面へ遷移

3. **書籍を登録する**
   - ユーザーがヘッダーの「+ 登録」をタップ
   - 書籍登録画面へ遷移

### 書籍登録

**画面構成:**
- 入力モード切り替え（バーコードスキャン / 手動入力）
- **バーコードスキャンモード:**
  - カメラプレビュー
  - スキャン状態表示
  - 登録成功/失敗フィードバック
- **手動入力モード:**
  - ISBN入力フィールド（自動取得用）
  - または書籍情報の手動入力フォーム
    - タイトル（必須）
    - 著者（複数入力可）
    - 出版社
    - 出版日
    - サムネイルURL

**ユースケース:**
1. **バーコードスキャンで登録**
   - ユーザーが書籍登録画面を開く
   - デフォルトでカメラが起動
   - 書籍のバーコードをスキャン
   - 書籍情報が自動取得され登録される
   - 成功メッセージが表示される

2. **ISBN手動入力で登録**
   - ユーザーが「手動入力」モードに切り替え
   - ISBN入力フィールドにISBNを入力
   - 書籍情報が自動取得され登録される

3. **書籍情報を手動入力で登録（ISBNがない本）**
   - ユーザーがすべての項目を手動入力
   - タイトル、著者、出版社などを入力
   - 登録ボタンをタップ
   - 書籍が登録される

### 貸出・返却

**画面構成:**
- **バーコードスキャンエリア（折りたたみ可能）:**
  - デフォルト: 展開（カメラ起動中）
  - カメラプレビュー
  - 「カメラを閉じる ▲」ボタン
  - スキャン状態表示
- **借りている本一覧:**
  - 書籍カード（サムネイル、タイトル、著者、借りた日時）
  - 各書籍に「返却」ボタン
  - 借りている本がない場合は空状態を表示

**ユースケース:**
1. **バーコードスキャンで貸出**
   - ユーザーが貸出・返却タブを開く
   - カメラが自動起動
   - 貸出可能な書籍のバーコードをスキャン
   - 貸出が実行される
   - 成功フィードバック表示
   - 「借りている本一覧」に追加される

2. **バーコードスキャンで返却**
   - ユーザーが貸出・返却タブを開く
   - 自分が借りている本のバーコードをスキャン
   - 返却が実行される
   - 成功フィードバック表示
   - 「借りている本一覧」から削除される

3. **マニュアル操作で返却**
   - ユーザーが「カメラを閉じる」をタップ（または下にスクロール）
   - 借りている本の一覧が表示される
   - 返却したい書籍の「返却」ボタンをタップ
   - 返却が実行される
   - 一覧から削除される

4. **他人が借りている本をスキャン（エラーケース）**
   - ユーザーが他人が借りている本をスキャン
   - エラーメッセージ表示: 「○○さんが借りています」

5. **借りている本を確認**
   - ユーザーが「カメラを閉じる」をタップ
   - カメラが停止し、一覧が全画面表示される
   - 借りている本の詳細（タイトル、著者、借りた日時）を確認
   - 書籍カードをタップで書籍詳細画面へ遷移

### 書籍詳細

**画面構成:**
- 書籍情報（サムネイル、タイトル、著者、出版社、出版日、ISBN）
- 貸出状況
  - 貸出可能 / 貸出中（利用者名、借りた日時）
- アクションボタン
  - 貸出可能な場合: 「貸出」ボタン
  - 自分が借りている場合: 「返却」ボタン
  - 他人が借りている場合: ボタン非表示
  - 貸出可能な場合のみ: 「削除」ボタン

**ユースケース:**
1. **書籍を貸し出す**
   - ユーザーが書籍詳細画面で「貸出」ボタンをタップ
   - 貸出が実行される
   - ステータスが「貸出中」に変わる
   - 自分の名前が表示される

2. **書籍を返却する**
   - ユーザーが自分が借りている書籍の詳細画面で「返却」ボタンをタップ
   - 返却が実行される
   - ステータスが「貸出可能」に変わる

3. **書籍を削除する**
   - ユーザーが貸出可能な書籍の詳細画面で「削除」ボタンをタップ
   - 削除理由選択ダイアログが表示される
   - 削除理由（譲渡/破棄/紛失/その他）を選択
   - メモ（任意）を入力
   - 確認ダイアログで「削除」を確定
   - 書籍が削除される（ReadModelから除外、イベントは残る）
   - ライブラリ画面に戻る

### その他

**画面構成:**
- ユーザー情報
  - ユーザー名表示
  - 「ユーザー名を変更」ボタン
- 設定・機能リスト
  - （将来の拡張用）
  - 統計・レポート
  - 通知設定
  - ヘルプ
  - アプリについて

**ユースケース:**
1. **ユーザー名を変更する**
   - ユーザーが「その他」タブを開く
   - 「ユーザー名を変更」をタップ
   - 新しいユーザー名を入力
   - 保存ボタンをタップ
   - ユーザー名が更新される

### ユーザー名の自動生成

- サーバー側でユーザー初回アクセス時に `ゲスト{ランダム4桁}` を自動設定
- または Firebase UIDの末尾4桁を使う
